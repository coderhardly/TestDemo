
@model PagedList.IPagedList<Model.Products>
@using PagedList.Mvc
@{
    Layout = null;
}
<link href="~/Content/bootstrap.min.css" rel="stylesheet" />

<div class="container" style="margin:50px;">
    <p>
        <button class="btn btn-primary btn-sm" data-toggle="modal" data-target="#addProduct">添加产品</button>
    </p>
    <!-- 模态框（Modal） -->
    <div class="modal fade" id="addProduct" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">添加产品</h4>
                </div>
                <div class="modal-body">
                    <div>
                        <form id="addForm">
                            <input type="file" name="MenuIcon" id="imgIcon" />
                            <input type="button" id="btnUpload" value="图片上传" />
                            @*<input type="hidden" id="hidImage" name="ImagePath" value="" />*@
                            <div id="menuIconShow">
                                @*<img src="#" id="imgPath" style=" width:40px;height:40px" />*@
                            </div>
                        </form>
                    </div>
                    <div class="input-group input-group-lg">
                        <label>商品名</label>
                        <input id="apname" type="text" class="form-control" placeholder="商品名">
                    </div>
                    <br />
                    <div class="input-group input-group-lg">
                        <label>产品描述</label>
                        <input id="apdescript" type="text" class="form-control" placeholder="商品描述">
                    </div>
                    <br />
                    <div class="input-group input-group-lg">
                        <label>产品价格</label>
                        <input id="aprice" type="text" class="form-control" placeholder="价格">
                    </div>

                    <div>
                        <label>产品类别</label>
                        <input id="apcategory" type="text" class="form-control" placeholder="商品类别">
                    </div>
                    <div>
                        <label>产地</label>
                        <input id="aporigin" type="text" class="form-control" placeholder="产地">
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" id="addProduct1">添加产品</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>



    <table class="table">
        <tr>
            <th>

            </th>
            <th>
                产品Id
            </th>
            <th>
                产品名
            </th>
            <th>
                价格
            </th>
            <th>
                产地
            </th>
            <th>
                产品图片
            </th>
            <th>
                产品类别
            </th>
            @*<th>
                   产品描述
                </th>*@

            <th>操作</th>
        </tr>

        @foreach (var item in Model.ToList())
        {
            <tr>
                <td> <input type="checkbox" /></td>
                <td>
                    @Html.DisplayFor(modelItem => item.productId)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.pname)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.price)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.origin)
                </td>
                <td>
                    <img src="~/Content/ProductImages/@item.pUrl" style="width:50px;height:50px;" />
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.pcategoryId)
                </td>


                <td>
                    @Html.ActionLink("删除", "Delete", new { id = item.productId })|
                    <a href="#" onclick="editInfo(this)" data-toggle="modal" data-target="#editProduct">编辑</a>
                </td>
            </tr>
        }

    </table>
    <div class="modal fade" id="editProduct" tabindex="-1" role="dialog" aria-labelledby="my" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">修改产品</h4>
                </div>
                <div class="modal-body">
                    <div class="input-group input-group-lg">
                        <label>产品名</label>
                        <input id="pname" type="text" class="form-control" value="1">
                        <input id="pId" type="hidden" j class="form-control" value="1">
                    </div>
                    <br />


                    <div class="input-group input-group-lg">
                        <label>产品价格</label>
                        <input id="price" type="text" class="form-control" value="" placeholder="">
                    </div>

                    <div>
                        <label>产品类别</label>
                        <input id="pCategoryId" type="text" class="form-control" value="" placeholder="">
                    </div>
                    <div>
                        <label>产地</label>
                        <input id="pOrigin" type="text" class="form-control" value="" placeholder="">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                    <button id="update" type="button" class="btn btn-primary">提交更改</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal -->
    </div>
</div>
每页 @Model.PageSize 条记录，共 @Model.PageCount 页，当前第 @Model.PageNumber 页
@Html.PagedListPager(Model, pageIndex => Url.Action("ProductList", new { pageIndex }))
<script src="~/Scripts/jquery-1.7.min.js"></script>
<script src="~/Scripts/MyAjaxForm.js"></script>
<script src="~/Scripts/bootstrap.min.js"></script>
<script type="text/javascript">
    $(function () {
        $("#btnUpload").click(function () {
            if ($("#imgIcon").val() == "") {
                alert("请选择图片文件");
                return;
            }
            $("#addForm").ajaxSubmit({
                type: 'post',
                url: '/Product/FileUpload',
                success: function (data) {
                    var serverData = data.split(':');
                    if (serverData[0] == "ok") {
                        /*  $("#hidImage").attr("value", serverData[1]);*///将服务端返回的图片路径赋给隐藏域
                        $("#menuIconShow").html("");//先清除以前的，然后再添加。
                        $("#menuIconShow").append("<img src='" + serverData[1] + "' width='40px' height='40px' />");
                        console.log("上传成功")
                    } else {
                        $.messager.alert("提示", "图片上传错误!");
                    }
                }
            });

        });
        $("#update").click(function () {
            var pid = $("#pId").val();
            var pname = $("#pname").val();
            var price = $("#price").val();
            var pcategoryId = $("#pCategoryId").val();
            var porigin = $("#pOrigin").val();
            $.ajax({
                url: "/Product/UpdateProduct",
                type: "post",
                data: { pId: pid, pName: pname, pPrice: price, pCategoryId: pcategoryId, pOrigin: porigin },
                success: function (data) {
                    if (data.flag == true) {
                        console.log("success");
                        window.location = "/Product/ProductList"
                    }
                    else {
                        alert("亲，因为未知的元素，程序出错");
                    }
                }
            })
        })

        $("#addProduct1").click(function () {
            var name = $("#apname").val();
            var des = $("#apdescript").val().trim();
            var price = $("#aprice").val().trim();
            alert(price);

            var cate = $("#apcategory").val().trim();
            var origin = $("#aporigin").val().trim();
            alert(origin)
            var photo = $("#menuIconShow img").attr("src").trim();
            alert(photo);
            $.ajax({
                url: "/Product/AddProduct",
                type: "post",
                data: { pName: name, pPrice: price, pCategoryId: cate, pOrigin: origin, photo: photo, pDes: des },
                success: function (data) {
                    if (data.flag == true) {
                        alert("success");
                        window.location = "/Product/ProductList";
                    }
                    else {
                        alert("亲，因为未知的元素，程序出错");
                    }
                }
            })


        })
    })

    //封装的函数不能写在主函数内，否则会找不到
    //给模态框内的文本框赋值
    function editInfo(obj) {

        var cur = $(obj).parent().parent().find('td');
        $("pId").val(cur.eq(1).text());
        $("#pname").val(cur.eq(2).text());
        $("#price").val(cur.eq(3).text());
        $("#pOrigin").val(cur.eq(4).text());
        $("#pCategoryId").val(cur.eq(6).text());
        $("#editProduct").modal('show');
    };

</script>